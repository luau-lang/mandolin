name: Update Lute

on:
  pull_request:
    branches: ["master"]
  schedule:
    - cron: "0 0 * * 6"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lute:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest Lute release
        id: latest-release
        run: |
          # Fetch the latest release tag from luau-lang/lute
          LATEST_LUTE=$(
            curl -s https://api.github.com/repos/luau-lang/lute/releases \
            | jq -r 'map(select(.draft | not))[0]?.tag_name'
          )
          echo "Latest Lute release: $LATEST_LUTE"
          echo "tag=$LATEST_LUTE" >> $GITHUB_OUTPUT

      - name: Check current version
        id: current-version
        run: |
          CURRENT_LUTE=$(grep '^lute = ' rokit.toml | sed -E 's/^lute = ".*@(.*)"/\1/')
          echo "Current Lute version: $CURRENT_LUTE"
          echo "lute=$CURRENT_LUTE" >> $GITHUB_OUTPUT

      - name: Update version files
        run: |
          # Update lute version in foreman.toml
          if [ "${{ steps.current-version.outputs.lute }}" != "${{ steps.latest-release.outputs.tag }}" ]; then
            sed -i 's/^lute = { github = "luau-lang\/lute", version = ".*" }/lute = { github = "luau-lang\/lute", version = "=${{ steps.latest-release.outputs.tag }}" }/' foreman.toml
            echo "Updated foreman.toml:"
            cat foreman.toml
          fi

      - name: Create Pull Request
        if: steps.current-version.outputs.lute != steps.latest-release.outputs.tag
        uses: luau-lang/create-pull-request@v7
        with:
          commit-message: "chore: update dependencies"
          title: "Update Lute to ${{ steps.latest-release.outputs.tag }}"
          body: |
            ${{ format('**Lute**: Updated from `{0}` to `{1}`', steps.current-version.outputs.lute, steps.latest-release.outputs.tag)}}

            **Release Notes:**
            ${{ format('https://github.com/luau-lang/lute/releases/tag/{0}', steps.latest-release.outputs.tag)}}

            ---
            *This PR was automatically created by the [Update Luau workflow](https://github.com/${{ github.repository }}/actions/workflows/update-prs.yml)*
          branch: update-lute
          delete-branch: true

      - name: No update needed
        if: steps.current-version.outputs.lute == steps.latest-release.outputs.tag
        run: |
          echo "Lute is already up to date: ${{ steps.current-version.outputs.lute }}"
